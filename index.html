<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Excel Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-drop-area {
            transition: all 0.3s ease;
        }
        .file-drop-area.dragover {
            background-color: #e0f2fe; /* light blue */
            border-color: #38bdf8; /* sky blue */
        }
        #preview-container table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Helps with word wrapping */
        }
        #preview-container th, #preview-container td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #preview-container th {
            background-color: #f8fafc;
        }
        .view-toggle-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .view-toggle-btn.inactive {
             background-color: #e5e7eb;
            color: #374151;
        }
        /* Style for the prompt editor */
        details > summary {
            cursor: pointer;
            list-style: none; /* Remove default marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Remove default marker for Chrome */
        }
        details[open] summary .fa-chevron-down {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-8 my-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Multilingual Excel Translator</h1>
            <p class="text-gray-500 mt-2">Upload an Excel file, choose a language, and let Gemini AI translate it for you.</p>
        </div>

        <!-- Step 1: API Key -->
        <div class="mb-6">
            <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-key mr-2 text-gray-400"></i>Enter your Gemini API Key
            </label>
            <div class="relative">
                <input type="password" id="apiKey" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your API key goes here">
                <button id="toggleApiKey" class="absolute inset-y-0 right-0 px-4 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Upload and Language Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-file-excel mr-2 text-gray-400"></i>Upload Excel File
                </label>
                <div id="file-drop-area" class="file-drop-area relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls">
                    <div class="text-gray-500">
                        <i class="fas fa-cloud-upload-alt text-4xl mb-3"></i>
                        <p id="file-name" class="font-semibold">Drag & drop or click to upload</p>
                        <p class="text-xs">Supported formats: .xlsx, .xls</p>
                    </div>
                </div>
            </div>
            <div>
                <label for="language" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-language mr-2 text-gray-400"></i>Translate to
                </label>
                <select id="language" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 h-[108px]">
                    <option value="Hindi">Hindi</option>
                    <option value="Marathi">Marathi</option>
                </select>
            </div>
        </div>

        <!-- Step 3: Prompt Editor -->
        <div class="mb-6">
            <details open>
                <summary class="font-medium text-gray-700 flex justify-between items-center">
                    <span><i class="fas fa-pencil-alt mr-2 text-gray-400"></i>Edit API Prompt for Selected Language</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </summary>
                <div class="mt-2">
                    <textarea id="promptInput" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                </div>
            </details>
        </div>

        <!-- Action Button -->
        <div class="text-center my-6">
            <button id="translateBtn" class="w-full md:w-1-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100">
                <i class="fas fa-sync-alt mr-2"></i>Translate
            </button>
        </div>
        
        <!-- Status & Messages -->
        <div id="status" class="text-center py-2 text-sm font-medium rounded-lg mb-4" role="alert"></div>

        <!-- Preview & Download Section -->
        <div id="result-section" class="hidden">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center gap-2">
                    <h2 class="text-xl font-bold text-gray-700">Preview</h2>
                    <div class="flex rounded-lg p-1 bg-gray-200">
                        <button id="viewTranslatedBtn" class="view-toggle-btn active px-3 py-1 text-sm font-semibold rounded-md transition-colors">Translated</button>
                        <button id="viewOriginalBtn" class="view-toggle-btn inactive px-3 py-1 text-sm font-semibold rounded-md transition-colors">Original</button>
                    </div>
                </div>
                <button id="downloadBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
                    <i class="fas fa-download mr-2"></i>Download Translated Excel
                </button>
            </div>
            <div id="preview-container" class="max-h-96 overflow-auto border border-gray-200 rounded-lg shadow-inner">
                <!-- Translated table will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const toggleApiKey = document.getElementById('toggleApiKey');
        const fileInput = document.getElementById('fileInput');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileNameDisplay = document.getElementById('file-name');
        const languageSelect = document.getElementById('language');
        const translateBtn = document.getElementById('translateBtn');
        const statusDiv = document.getElementById('status');
        const resultSection = document.getElementById('result-section');
        const previewContainer = document.getElementById('preview-container');
        const downloadBtn = document.getElementById('downloadBtn');
        const promptInput = document.getElementById('promptInput');
        const viewTranslatedBtn = document.getElementById('viewTranslatedBtn');
        const viewOriginalBtn = document.getElementById('viewOriginalBtn');

        let originalData = null;
        let translatedData = null;
        let originalHeaders = null;
        let editedPrompts = {};

        const PROMPT_TEMPLATES = {
            'Hindi': `Please translate without creativity or rephrasing unless necessary for clarity.
You are a professional educational language translator with experience in scenario-based aptitude and behavioural assessments. Your task is to translate the following English JSON data into Hindi.
These questions assess practical decision-making, interpersonal judgment, or cognitive skills in real-life or workplace scenarios.
Follow these instructions precisely:
1.  Translate into standard Hindi, understandable to a learner with a 10th-grade reading level. Use a formal yet clear tone appropriate for academic or exam use. Avoid literary, poetic, overly Sanskritised, or conversational constructions. Do not use slang or region-specific expressions.
2.  Ensure all language is gender-neutral, unless the original English text explicitly specifies gender.
3.  If any word, phrase, or sentence in English is being tested (such as in synonym, idiom, or paraphrasing questions), retain it in English. Do not translate it.
4.  The translation must preserve the meaning, tone, and logic of the original question. The correct answer must remain valid in the Hindi version.
5.  Maintain the structure and flow of the question and options unless a slight adjustment improves clarity in Hindi.
6.  If the original English input is ambiguous, unclear, or poorly written, flag it for review instead of attempting to interpret.
7.  Translate text and convert numbers to their Hindi script equivalents (e.g., 1 to १, 2 to २).
8.  When you encounter single English letters used as labels (e.g., 'Assertion (A)', 'Strategy B'), translate them to their corresponding Devanagari letters (e.g., 'अभिकथन (अ)', 'रणनीति ब') unless they are part of a specific term that must remain in English.
9.  Maintain the exact JSON structure (keys and nesting). Only translate the string values and convert numbers. Do not translate the keys.
10. Return ONLY the translated JSON array, without any surrounding text, explanations, or markdown formatting like \`\`\`json.`,
            'Marathi': `Please translate without creativity or rephrasing unless necessary for clarity.
You are a professional educational language translator with experience in scenario-based aptitude and behavioural assessments. Your task is to translate the following English JSON data into Marathi.
These questions test practical reasoning, workplace behaviour, communication, or decision-making in real or simulated situations.
Follow these instructions precisely:
1.  Translate into standard Marathi, suitable for a learner at the 10th-grade reading level. Use a formal yet clear tone.
2.  Ensure all language is gender-neutral, unless the original English text explicitly specifies gender.
3.  The translation must preserve the meaning, tone, and logic of the original question. The correct answer must remain valid in the Marathi version.
4.  Translate text and convert numbers to their Marathi script equivalents (e.g., 1 to १, 2 to २).
5.  When you encounter single English letters used as labels (e.g., 'Assertion (A)', 'Strategy B'), translate them to their corresponding Devanagari letters (e.g., 'अभिकथन (अ)', 'रणनीति ब') unless they are part of a specific term that must remain in English.
6.  Maintain the exact JSON structure (keys and nesting). Only translate the string values and convert numbers. Do not translate the keys.
7.  Return ONLY the translated JSON array, without any surrounding text, explanations, or markdown formatting like \`\`\`json.`
        };

        // --- Initial Setup ---
        
        function updatePromptForLanguage() {
            const selectedLanguage = languageSelect.value;
            if (editedPrompts[selectedLanguage]) {
                promptInput.value = editedPrompts[selectedLanguage];
            } else {
                promptInput.value = PROMPT_TEMPLATES[selectedLanguage];
            }
        }
        updatePromptForLanguage();


        // --- Event Listeners ---

        toggleApiKey.addEventListener('click', () => {
            const icon = toggleApiKey.querySelector('i');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                apiKeyInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
        fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });
        
        fileInput.addEventListener('change', handleFileSelect);
        translateBtn.addEventListener('click', handleTranslate);
        downloadBtn.addEventListener('click', downloadExcel);
        viewTranslatedBtn.addEventListener('click', () => toggleView(true));
        viewOriginalBtn.addEventListener('click', () => toggleView(false));
        languageSelect.addEventListener('change', updatePromptForLanguage);
        promptInput.addEventListener('input', () => {
            const selectedLanguage = languageSelect.value;
            editedPrompts[selectedLanguage] = promptInput.value;
        });
       
        // --- Core Functions ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add('text-blue-600');
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                originalData = XLSX.utils.sheet_to_json(worksheet);
                if (originalData.length > 0) {
                    originalHeaders = Object.keys(originalData[0]);
                }
                resultSection.classList.add('hidden'); // Hide old results
            };
            
            reader.onerror = () => {
                 showMessage('Error reading the file.', true);
                 originalData = null;
                 originalHeaders = null;
            };

            reader.readAsArrayBuffer(file);
        }
        
        function parseApiResponse(jsonString) {
            let dataToParse = jsonString
                .replace(/^```json\s*/, '')
                .replace(/```$/, '')
                .trim();

            if (dataToParse.startsWith('"') && dataToParse.endsWith('"')) {
                try {
                    dataToParse = JSON.parse(dataToParse);
                } catch (e) {
                    console.warn("Could not unwrap double-stringified JSON, proceeding as is.", e);
                }
            }
            
            if (typeof dataToParse === 'object' && dataToParse !== null) {
                return dataToParse;
            }

            if (typeof dataToParse === 'string') {
                const fixedJsonString = dataToParse
                    .replace(/_x000d_/g, '')
                    .replace(/:\s*([०-९\.]+)\s*([,}])/g, ': "$1"$2');
                try {
                    return JSON.parse(fixedJsonString);
                } catch (error) {
                    console.warn(`Initial JSON parse failed: "${error.message}". Retrying with repairs.`);
                    try {
                        // This regex targets backslashes that are NOT followed by a valid JSON escape character.
                        const repairedJson = fixedJsonString.replace(/\\(?!["\\/bfnrtu])/g, '\\\\');
                        return JSON.parse(repairedJson);
                    } catch (finalError) {
                        console.error("All JSON parsing attempts failed.", {
                            original: jsonString,
                            error: finalError,
                        });
                        throw finalError;
                    }
                }
            }
            
            throw new Error("Could not parse API response into a valid object or array.");
        }


        async function handleTranslate() {
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                showMessage('Please enter your Gemini API key.', true);
                return;
            }
            if (!originalData || originalData.length === 0) {
                showMessage('Please upload a valid Excel file with content.', true);
                return;
            }

            setLoading(true);
            resultSection.classList.add('hidden');
            previewContainer.innerHTML = '';
            
            const systemPrompt = promptInput.value;
            const language = languageSelect.value;
            
            // Filter data: separate rows to translate from rows to keep in English
            const dataToTranslate = originalData.filter(row => 
                row['Subskill'] !== 'Verbal Reasoning'
            );
            
            const headersUserPrompt = `Translate the following comma-separated list of column headers into ${language}. Return ONLY the translated comma-separated list, without any extra text or explanations.\n\n${originalHeaders.join(', ')}`;
            
            try {
                // Step 1: Translate Headers
                const translatedHeadersText = await callGeminiAPI(`You are a concise translator.`, headersUserPrompt, apiKey);
                const translatedHeaders = translatedHeadersText.split(',').map(h => h.trim());

                if (translatedHeaders.length !== originalHeaders.length) {
                    throw new Error("Header translation failed: Mismatch in column count.");
                }

                // Step 2: Translate Data in Chunks
                let translatedRowValues = [];
                const CHUNK_SIZE = 10; // Reduced chunk size for more reliability
                const totalChunks = Math.ceil(dataToTranslate.length / CHUNK_SIZE);

                for (let i = 0; i < totalChunks; i++) {
                    const chunk = dataToTranslate.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                    if (chunk.length === 0) continue;

                    showMessage(`Translating chunk ${i + 1} of ${totalChunks}...`, false);
                    
                    const dataUserPrompt = `Translate the following JSON data according to the instructions:\n\n${JSON.stringify(chunk, null, 2)}`;
                    const translatedJsonString = await callGeminiAPI(systemPrompt, dataUserPrompt, apiKey);
                    const parsedChunk = parseApiResponse(translatedJsonString);
                    translatedRowValues.push(...parsedChunk);
                }


                // Step 3: Reconstruct the full data set
                let translatedDataCounter = 0;
                translatedData = originalData.map(originalRow => {
                    const newRow = {};
                    const shouldSkipTranslation = originalRow['Subskill'] === 'Verbal Reasoning';
                    
                    const sourceRow = shouldSkipTranslation 
                        ? originalRow 
                        : translatedRowValues[translatedDataCounter];

                    if (sourceRow) {
                         originalHeaders.forEach((originalHeader, index) => {
                            const translatedHeader = translatedHeaders[index];
                            newRow[translatedHeader] = sourceRow[originalHeader];
                        });
                        
                        if (!shouldSkipTranslation) {
                             translatedDataCounter++;
                        }
                    }
                    return newRow;
                });
                
                displayPreview(translatedData);
                resultSection.classList.remove('hidden');
                toggleView(true);
                showMessage('Translation successful!', false);

            } catch (error) {
                console.error('Translation Error:', error);
                const errorMessage = error.message.includes('JSON Parse error') 
                    ? `JSON Parse error: The API returned an invalid format. ${error.message}`
                    : `Translation failed. Error: ${error.message}. Check console for details.`;
                showMessage(errorMessage, true);
                translatedData = null;
            } finally {
                setLoading(false);
            }
        }

        async function callGeminiAPI(systemPrompt, userPrompt, apiKey) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: { temperature: 0.2, topP: 1.0, topK: 32, maxOutputTokens: 8192 },
                safetySettings: [
                    { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                ]
            };

            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            console.error("API Response with no content:", JSON.stringify(result, null, 2));
                            throw new Error("API returned a successful response but with no content. Check safety filters or console for details.");
                        }
                    }

                    if (response.status === 503 || response.status === 429) {
                        console.warn(`API returned status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }

                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.statusText} - ${errorBody.error?.message || 'Unknown error'}`);

                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed with error:`, error);
                    if (i === maxRetries - 1) throw error;
                    console.warn(`Retrying...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error('API request failed after multiple retries.');
        }

        function displayPreview(data) {
            if (!data || data.length === 0) {
                previewContainer.innerHTML = '<p class="p-4 text-center text-gray-500">No data to display.</p>';
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headers = Object.keys(data[0]);

            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            previewContainer.innerHTML = '';
            previewContainer.appendChild(table);
        }

        function downloadExcel() {
            if (!translatedData) {
                showMessage('No translated data available to download.', true);
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(translatedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'TranslatedSheet');
            
            const originalFileName = fileInput.files[0]?.name.replace(/\.(xlsx|xls)$/, '') || 'translated';
            const translatedFileName = `${originalFileName}_${languageSelect.value}.xlsx`;

            XLSX.writeFile(workbook, translatedFileName);
        }

        // --- UI Helper Functions ---

        function toggleView(showTranslated) {
            if (showTranslated && translatedData) {
                displayPreview(translatedData);
                viewTranslatedBtn.classList.replace('inactive', 'active');
                viewOriginalBtn.classList.replace('active', 'inactive');
            } else if (originalData) {
                const originalDataWithOriginalHeaders = originalData.map(row => {
                    const newRow = {};
                    originalHeaders.forEach(header => {
                        newRow[header] = row[header];
                    });
                    return newRow;
                });
                displayPreview(originalDataWithOriginalHeaders);
                viewOriginalBtn.classList.replace('inactive', 'active');
                viewTranslatedBtn.classList.replace('active', 'inactive');
            }
        }

        function setLoading(isLoading) {
            translateBtn.disabled = isLoading;
            if (isLoading) {
                translateBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Translating...`;
                showMessage('Processing your file. Please wait...', false);
            } else {
                translateBtn.innerHTML = `<i class="fas fa-sync-alt mr-2"></i>Translate`;
            }
        }

        function showMessage(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = 'text-center py-2 text-sm font-medium rounded-lg mb-4'; // Reset classes
            if (isError) {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (message.includes('successful')) {
                 statusDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                 statusDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
        }
    </script>

</body>
</html>
