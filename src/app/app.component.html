<div class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-8 my-8">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Multilingual Excel Translator</h1>
      <p class="text-gray-500 mt-2">Upload an Excel file, choose a language, and let Gemini AI translate it for you.</p>
    </div>

    <!-- Step 1: API Key Management -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <label for="apiKey" class="block text-sm font-medium text-gray-700">
          <i class="fas fa-key mr-2 text-gray-400"></i>Select Gemini API Key
        </label>
        <button 
          type="button"
          (click)="toggleApiKeyManager()"
          class="text-sm text-blue-600 hover:text-blue-800 font-medium">
          <i class="fas fa-cog mr-1"></i>Manage Keys
        </button>
      </div>
      
      <!-- API Key Selector -->
      <div class="relative mb-3">
        <select 
          id="apiKeySelect"
          [(ngModel)]="selectedApiKeyIndex"
          (change)="selectApiKey(selectedApiKeyIndex)"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="-1">Select an API Key</option>
          <option *ngFor="let key of savedApiKeys; let i = index" [value]="i">
            {{ maskedApiKey(key) }}
          </option>
        </select>
      </div>
      
      <!-- Manual API Key Input -->
      <div class="relative">
        <input 
          type="{{ showApiKey ? 'text' : 'password' }}" 
          id="apiKey" 
          [(ngModel)]="apiKey"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
          placeholder="Or enter your API key manually"
          aria-label="Gemini API Key"
          autocomplete="off">
        <button 
          type="button"
          (click)="toggleApiKeyVisibility()"
          class="absolute inset-y-0 right-0 px-4 text-gray-500 hover:text-gray-700"
          [attr.aria-label]="showApiKey ? 'Hide API key' : 'Show API key'">
          <i class="fas" [class.fa-eye]="!showApiKey" [class.fa-eye-slash]="showApiKey"></i>
        </button>
      </div>
      
      <!-- API Key Manager -->
      <div *ngIf="showApiKeyManager" class="mt-4 p-4 bg-gray-50 rounded-lg border">
        <h3 class="text-sm font-medium text-gray-700 mb-3">
          <i class="fas fa-cog mr-2"></i>API Key Manager
        </h3>
        
        <!-- Add New API Key -->
        <div class="mb-4">
          <label class="block text-xs font-medium text-gray-600 mb-1">Add New API Key</label>
          <div class="flex gap-2">
            <input 
              type="password"
              [(ngModel)]="newApiKey"
              class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter new API key">
            <button 
              type="button"
              (click)="addNewApiKey()"
              class="px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
              <i class="fas fa-plus mr-1"></i>Add
            </button>
          </div>
        </div>
        
        <!-- Saved API Keys List -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-2">Saved API Keys</label>
          <div class="space-y-2">
            <div *ngFor="let key of savedApiKeys; let i = index" 
                 class="flex items-center justify-between p-2 bg-white rounded border">
              <div class="flex items-center">
                <input 
                  type="radio" 
                  [id]="'key-' + i"
                  [value]="i"
                  [(ngModel)]="selectedApiKeyIndex"
                  (change)="selectApiKey(i)"
                  class="mr-2">
                <label [for]="'key-' + i" class="text-sm font-mono text-gray-700">
                  {{ maskedApiKey(key) }}
                </label>
              </div>
              <button 
                *ngIf="savedApiKeys.length > 1"
                type="button"
                (click)="removeApiKey(i)"
                class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Upload and Language Selection -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-file-excel mr-2 text-gray-400"></i>Upload Excel File
        </label>
        <div 
          class="file-drop-area relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onFileDropped($event)"
          role="button"
          tabindex="0"
          aria-label="File upload area"
          (keydown.enter)="fileInput.click()"
          (keydown.space)="fileInput.click()">
          <input 
            #fileInput
            type="file" 
            id="fileInput" 
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
            accept=".xlsx, .xls"
            (change)="onFileSelected($event)"
            aria-label="Select Excel file">
          <div class="text-gray-500">
            <i class="fas fa-cloud-upload-alt text-4xl mb-3"></i>
            <p class="font-semibold" [class.text-blue-600]="selectedFile">{{ fileName }}</p>
            <p class="text-xs">Supported formats: .xlsx, .xls</p>
          </div>
        </div>
      </div>
      <div>
        <label for="language" class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-language mr-2 text-gray-400"></i>Translate to
        </label>
        <select 
          id="language" 
          [(ngModel)]="selectedLanguage"
          (change)="onLanguageChange()"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 h-[108px]">
          <option value="Hindi">Hindi</option>
          <option value="Marathi">Marathi</option>
        </select>
      </div>
    </div>

    <!-- Step 3: Prompt Editor -->
    <div class="mb-6">
      <details open>
        <summary class="font-medium text-gray-700 flex justify-between items-center">
          <span><i class="fas fa-pencil-alt mr-2 text-gray-400"></i>Edit API Prompt for Selected Language</span>
          <i class="fas fa-chevron-down transition-transform"></i>
        </summary>
        <div class="mt-2">
          <textarea 
            id="promptInput" 
            rows="10" 
            [(ngModel)]="customPrompt"
            (input)="onPromptChange()"
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
        </div>
      </details>
    </div>

    <!-- Action Button -->
    <div class="text-center my-6">
      <button 
        type="button"
        (click)="translate()"
        [disabled]="isLoading"
        class="w-full md:w-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100">
        <i class="fas" [class.fa-spinner]="isLoading" [class.fa-sync-alt]="!isLoading" [class.fa-spin]="isLoading" class="mr-2"></i>
        {{ isLoading ? 'Translating...' : 'Translate' }}
      </button>
    </div>

    <!-- Progress Bar -->
    <div *ngIf="isTranslationInProgress" class="mb-6">
      <div class="bg-white rounded-lg p-4 shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">{{ translationProgress.currentStep }}</span>
          <span class="text-sm text-gray-500">{{ progressPercentage }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div 
            class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-out"
            [style.width.%]="progressPercentage">
          </div>
        </div>
        <div class="mt-2 text-xs text-gray-500 text-center">
          Chunk {{ translationProgress.currentChunk }} of {{ translationProgress.totalChunks }}
        </div>
      </div>
    </div>
    
    <!-- Status & Messages -->
    <div *ngIf="statusMessage" [class]="statusClasses" role="alert">
      {{ statusMessage }}
    </div>

    <!-- Preview & Download Section -->
    <div *ngIf="showResults" class="block">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
        <div class="flex items-center gap-2">
          <h2 class="text-xl font-bold text-gray-700">Preview</h2>
          <div class="flex rounded-lg p-1 bg-gray-200">
            <button 
              type="button"
              (click)="toggleView(true)"
              class="view-toggle-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors"
              [class.active]="showTranslatedView"
              [class.inactive]="!showTranslatedView">
              Translated
            </button>
            <button 
              type="button"
              (click)="toggleView(false)"
              class="view-toggle-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors"
              [class.active]="!showTranslatedView"
              [class.inactive]="showTranslatedView">
              Original
            </button>
          </div>
        </div>
        <button 
          type="button"
          (click)="downloadExcel()"
          class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
          <i class="fas fa-download mr-2"></i>Download Translated Excel
        </button>
      </div>
      <div id="preview-container" class="max-h-96 overflow-auto border border-gray-200 rounded-lg shadow-inner">
        <!-- Skeleton Loading -->
        <div *ngIf="isTranslationInProgress && !displayData.length" class="p-4">
          <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="space-y-3">
              <div class="h-3 bg-gray-200 rounded w-full"></div>
              <div class="h-3 bg-gray-200 rounded w-5/6"></div>
              <div class="h-3 bg-gray-200 rounded w-4/6"></div>
              <div class="h-3 bg-gray-200 rounded w-3/4"></div>
            </div>
          </div>
        </div>
        
        <!-- Data Table -->
        <table *ngIf="displayData.length > 0 && !isTranslationInProgress" class="w-full border-collapse">
          <thead>
            <tr>
              <th *ngFor="let header of displayHeaders" class="border border-gray-300 px-2 py-1 bg-gray-50 text-left">
                {{ header }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of displayData">
              <td *ngFor="let header of displayHeaders" class="border border-gray-300 px-2 py-1 text-left">
                {{ row[header] }}
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- Empty State -->
        <p *ngIf="displayData.length === 0 && !isTranslationInProgress" class="p-4 text-center text-gray-500">
          No data to display.
        </p>
      </div>
    </div>
  </div>
</div>
